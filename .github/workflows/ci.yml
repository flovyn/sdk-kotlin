name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  # Pin to specific sdk-rust release version
  # Update this when upgrading to a new FFI version
  FFI_VERSION: v0.1.4

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      # Download pre-built native libraries from sdk-rust release
      # NOTE: macOS and Windows ARM64 builds disabled in sdk-rust
      - name: Download native libraries from sdk-rust release
        run: |
          mkdir -p native/src/main/resources/natives/{linux-x86_64,linux-aarch64,windows-x86_64}
          mkdir -p native/src/main/kotlin/uniffi/flovyn_ffi

          # Download platform archives
          gh release download ${{ env.FFI_VERSION }} \
            --repo flovyn/sdk-rust \
            --pattern "libflovyn_ffi-*.tar.gz" \
            --dir ./tmp

          # Download bindings
          gh release download ${{ env.FFI_VERSION }} \
            --repo flovyn/sdk-rust \
            --pattern "flovyn-ffi-bindings.tar.gz" \
            --dir ./tmp

          # Extract native libraries (macOS and Windows ARM64 disabled)
          for platform in linux-x86_64 linux-aarch64 windows-x86_64; do
            tar -xzf tmp/libflovyn_ffi-${platform}.tar.gz -C native/src/main/resources/natives/
          done

          # Extract Kotlin bindings
          mkdir -p tmp/bindings
          tar -xzf tmp/flovyn-ffi-bindings.tar.gz -C ./tmp/bindings
          cp tmp/bindings/kotlin/uniffi/flovyn_ffi/* native/src/main/kotlin/uniffi/flovyn_ffi/

          # Cleanup
          rm -rf tmp
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build
        run: ./gradlew build

      - name: Run unit tests
        run: ./gradlew test

  e2e-test:
    runs-on: ubuntu-latest
    needs: build

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: flovyn
          POSTGRES_PASSWORD: flovyn
          POSTGRES_DB: flovyn
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # Uncomment when flovyn-server Docker image is available
      # flovyn-server:
      #   image: flovyn/server:latest
      #   ports:
      #     - 9090:9090
      #   env:
      #     DATABASE_URL: postgres://flovyn:flovyn@postgres:5432/flovyn
      #   options: >-
      #     --health-cmd "grpc_health_probe -addr=:9090"
      #     --health-interval 10s
      #     --health-timeout 5s
      #     --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      # Download native libraries for Linux (E2E tests run on Linux)
      - name: Download native libraries
        run: |
          mkdir -p native/src/main/resources/natives/linux-x86_64

          gh release download ${{ env.FFI_VERSION }} \
            --repo flovyn/sdk-rust \
            --pattern "libflovyn_ffi-linux-x86_64.tar.gz" \
            --dir ./tmp

          tar -xzf tmp/libflovyn_ffi-linux-x86_64.tar.gz -C native/src/main/resources/natives/
          rm -rf tmp
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run E2E tests
        run: ./gradlew :sdk-jackson:e2eTest
        env:
          FLOVYN_E2E_USE_DEV_INFRA: "1"
          FLOVYN_SERVER_ADDRESS: localhost:9090
